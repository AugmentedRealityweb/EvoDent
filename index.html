<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ChatGPT Integration</title>
    <link rel="stylesheet" href="styles.css"> <!-- Asigură-te că calea este corectă -->
</head>
<body>
    <div id="chatContainer">
        <div id="chatHeader" onclick="toggleChat()">
            <img src="https://evodent.ro/wp-content/uploads/2024/01/open-graph.jpg" alt="EvoDentBot">
            <span>EvoDentBot</span>
        </div>
        <div id="chatbox"></div>
        <div style="display: flex;">
            <input type="text" id="inputBox" placeholder="Scrie mesajul tau aici..." onkeydown="if(event.key === 'Enter') sendMessage()">
            <button id="sendButton" onclick="sendMessage()">Send</button>
        </div>
    </div>
    <div id="minimizedChat" onclick="toggleChat()">
        <img src="https://evodent.ro/wp-content/uploads/2024/01/open-graph.jpg" alt="EvoDentBot">
    </div>

    <script>
        const chatContainer = document.getElementById('chatContainer');
        const chatbox = document.getElementById('chatbox');
        const inputBox = document.getElementById('inputBox');
        const minimizedChat = document.getElementById('minimizedChat');
        let typingIndicator;

        function toggleChat() {
            if (chatContainer.style.display === 'none') {
                chatContainer.style.display = 'block';
                minimizedChat.style.display = 'none';
            } else {
                chatContainer.style.display = 'none';
                minimizedChat.style.display = 'flex';
            }
        }

        async function loadDocumentText() {
            const response = await fetch('https://raw.githubusercontent.com/AugmentedRealityweb/EvoDent/main/Steli.txt');
            const text = await response.text();
            return text;
        }

        function formatResponse(response) {
            return response.replace(/(?:\.\s*)/g, '.<br><br>');
        }

        async function sendMessage() {
            const message = inputBox.value;
            if (!message.trim()) return;
            inputBox.value = '';
            chatbox.innerHTML += `<div class="message user"><p>${message}</p></div>`;
            showTypingIndicator();

            const documentText = await loadDocumentText();

            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: "gpt-3.5-turbo",
                    messages: [
                        {
                            role: "system",
                            content: `You are EvoDentBot, a friendly and helpful AI assistant for our company. When you provide longer information, it should be structured, aligned and arranged in the chat page. You provide information and help customers as if you are an experienced employee of the company. The following is the knowledge base of the company: ${documentText}`
                        },
                        { role: "user", content: message }
                    ]
                })
            });

            const data = await response.json();

            if (data.choices && data.choices.length > 0) {
                let assistantMessage = data.choices[0].message.content;
                assistantMessage = formatResponse(assistantMessage);
                removeTypingIndicator();
                chatbox.innerHTML += `<div class="message assistant"><p>${assistantMessage}</p></div>`;
                chatbox.scrollTop = chatbox.scrollHeight;
            } else {
                removeTypingIndicator();
                chatbox.innerHTML += `<div class="message assistant"><p>There was an error processing your request. Please try again.</p></div>`;
                chatbox.scrollTop = chatbox.scrollHeight;
            }
        }

        function showTypingIndicator() {
            typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
            chatbox.appendChild(typingIndicator);
            chatbox.scrollTop = chatbox.scrollHeight;
        }

        function removeTypingIndicator() {
            if (typingIndicator) {
                typingIndicator.remove();
                typingIndicator = null;
            }
        }

        async function openChatWithInitialMessage() {
            toggleChat();
            chatbox.innerHTML += `<div class="message assistant"><p>Bună, eu sunt asistentul EvoDent, cu ce informații vă pot ajuta?</p></div>`;
        }

        window.onload = function() {
            chatContainer.style.display = 'none';
            minimizedChat.style.display = 'flex';
            setTimeout(() => {
                openChatWithInitialMessage();
            }, 2000);
        };
    </script>
</body>
</html>
